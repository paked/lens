<html>

<head>
    <style>
        body {
            background-color: black;

            color: #4df24d;

            font-family: 'Courier New', Courier, monospace;
        }

        .container {
            display: flex;
        }

        .container section {
            width: 50%;
        }

        #widget-holder canvas {
            margin-inline: auto;
        }
    </style>
    <script src="p5.js"></script>

</head>

<body>
    <div class="container">
        <section>
            <h1>Hacking Station</h1>

            <p>Possible ports (substitude for PORT_NAME)</p>
            <ul>
                <li>MODEM</li>
                <li>BEATS</li>
                <li>BASS</li>
                <li>CASSETTE</li>
                <li>PADS</li>
            </ul>
        
            <p>Arrays (substitute for ARRAY_NAME)</p>
            <ul>
                <li>calm_voice_1, calm_voice_2, calm_voice_3 (voices of the pads, 1 is on 0 is off)</li>
            </ul>

            <p>Values (substitute for VALUE_NAME</p>
            <ul>
                <li>bass: "beat-ratio"</li>
                <li>all: "drums-divider", "bass-divider", "pads-divider". sets the length of each note for the instrument. 4 is 4 beats, .25 is a quarter beat.</li>
                <li>pads: pads-punch</li>
                <li>beats: "beats-reverb</li>
            </ul>
        
            <p>list of commands</p>
            <ul>
                <li>birth PORT_NAME</li>
                <li>murder PORT_NAME</li>
                <li>list-set ARRAY_NAME</li>
                <li>value-set VALUE_NAME</li>
            </ul>
        
            <p>TODO commands</p>
            <ul>
                <li>vset PORT_NAME (volume set)</li>
                <li>kneecap PORT_NAME</li>
                <li>
                    for drums
                    <ul>
                        <li></li>
                    </ul>
                </li>
            </ul>
        
            <br>

            <br>
        
            <form id="form">
                <input id="cmd" type="text" placeholder="your command here" size="80" />

                <button onclick="go('quiz')">Enter command</button>
            </form>
        </section>

        <section>
            <div id="widget-holder"></div>
            <textarea id="out" cols="80" rows="5">
            </textarea>
        
            <button onclick="multiout()">send multicmd</button>
        </section>
    </div>

    <script>
        document.getElementById("form").addEventListener("submit", (event) => { event.preventDefault();})
        function question() {
            let a = Math.ceil(Math.random() * 10);
            let b = Math.ceil(Math.random() * 12);
            let c = Math.ceil(Math.random() * 5);

            let answer = prompt(`What is ${a} * ${b} * ${c}?`);

            return parseInt(answer) === a * b * c;
        }

        let ws = new WebSocket("wss://c987-150-203-68-107.au.ngrok.io");

        function go() {
            console.log('hi')
            let elem = document.getElementById('cmd');

            console.log("hello", elem.value)

            if (elem.value.startsWith("open")) {
                let sections = elem.value.split(' ');
                if (sections[1] === "PADS") {
                    state = "PADS";
                } else if (sections[1] === "BEATS") {
                    state = "BEATS";
                } else if (sections[1] === "BASS") {
                    state = "BASS";
                }

                return;
            } else if (elem.value.startsWith("close")) {
                state = "NONE";
                return;
            }

            ws.send(elem.value);
        }

        function multiout() {
            let cmds = document.getElementById('out').value.split('\n').filter(row => row.length !== 0);

            cmds.forEach(cmd => {
                console.log('sending', cmd);
                ws.send(cmd);
            })
        }
    </script>

    <script>
        let padRows = [[], [], []];

        let beatRows = [[], [], [], []];

        let state = "NONE";

        let count = 16;

        function setup() {
            let canvas = createCanvas(400, 400);
            canvas.parent('widget-holder');

            padRows = padRows.map(row => [...Array.from({ length: count }).fill(undefined)]);
            beatRows = beatRows.map(row => [...Array.from({ length: count }).fill(undefined)]);
        }

        let bassAtX = 0;
        let bassAtY = 0;

        function draw() {
            background('darkgreen');
            stroke('none');

            if (state === "BASS") {
                for (let i = 0; i < 7; i++) {
                    line(0, height/7*i, width, height/7*i);
                }

                if (mouseIsPressed) {
                    fill(0);

                    if (frameCount % 10 === 0) {
                        ws.send("tweak " + constrain(mouseX/width, 0, 1));
                        ws.send(`value-set bass-note ${Math.floor(constrain(mouseY/height, 0, 1)*7)}`);

                        bassAtX = mouseX;
                        bassAtY = mouseY;
                    }
                } else {
                    fill(255);
                }

                ellipse(mouseX, mouseY, 80, 80);

                fill('blue')
                circle(bassAtX, bassAtY, 40);
            } else if (state === "PADS") {
                document.getElementById('out').value = padRows.map((row, i) =>  {
                    return `list-set calm_voice_${i+1} ` + row.map(v => { 
                        if (!v) {
                            return 0;
                        }

                        let val = (height/padRows.length) - (v % Math.ceil(height/padRows.length));

                        let pc = val / (height/padRows.length);

                        return Math.ceil(pc * 8);
                    }).join(' ')
                }).join('\n');

                push()
                noStroke();
                padRows.forEach((_, i) => {
                    fill(i % 2 === 0 ? 'green' : 'grey');
                    rect(0, height/padRows.length*i, width, width/padRows.length*(i+1))
                })
                pop()

                for (let i = 0; i < 4; i++) {
                    fill(0, 30);
                    push()

                    noStroke();
                    if (i % 2 === 0) {
                        rect(width/4*i, 0, width/4, height)
                    }

                   pop()
                }

                if (mouseIsPressed && mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
                    let row = Math.floor(mouseY/(height/padRows.length));

                    let val = (keyIsDown(SHIFT)) ? undefined : mouseY;

                    padRows[row][Math.floor(mouseX/(width/count))] = val;
                }

                for (let i = 0; i < padRows.length; i++) {
                    let positions = padRows[i];
                    for (let x = 1; x < padRows[i].length; x++) {
                        if (!positions[x]|| !positions[x-1]) {
                            continue;
                        }

                        line((x-1 + .5)*(width/count), positions[x-1], (x+.5)*(width/count), positions[x]);
                    }

                    positions.forEach((y, x) => {
                        push();
                        if (Math.floor(mouseX/(width/count)) === x) {
                            fill("blue");
                        }
                        circle((x+.5)*(width/count), y, 10);
                        pop();
                    })
                }
            } else if (state === "BEATS") {
                document.getElementById('out').value = beatRows.map((row, i) => `list-set drums_${i+1} ` + row.map(v => v ? 1 : 0).join(' ')).join('\n');

                push()
                noStroke();
                beatRows.forEach((_, i) => {
                    fill(i % 2 === 0 ? 'green' : 'grey');
                    rect(0, height/beatRows.length*i, width, width/beatRows.length*(i+1))
                })
                pop()

                push()
                stroke("black")
                for (let i = 0; i < count; i++) {
                    if (i % 4 != 0) {
                        setLineDash([5, 5]);
                    } else {
                        setLineDash([1]);
                    }
                    line(i * width/count, 0, i * width/count, height);
                }
                pop()

                for (let i = 0; i < 4; i++) {
                    fill(0, 30);
                    push()

                    noStroke();
                    if (i % 2 === 0) {
                        rect(width/4*i, 0, width/4, height)
                    }

                    pop()
                }

                if (mouseIsPressed && mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
                    let row = Math.floor(mouseY/(height/beatRows.length));

                    let val = (keyIsDown(SHIFT)) ? undefined : mouseY;

                    beatRows[row][Math.floor(mouseX/(width/count))] = val;
                }

                for (let i = 0; i < beatRows.length; i++) {
                    let positions = beatRows[i];

                    positions.forEach((y, x) => {
                        push();
                        if (Math.floor(mouseX/(width/count)) === x) {
                            fill("blue");
                        }
                        circle((x+.5)*(width/count), y, 10);
                        pop();
                    })
                }
            }
        }

        function setLineDash(list) {
           drawingContext.setLineDash(list);
        }
    </script>
</body>

</html>