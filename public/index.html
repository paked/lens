<html>

<head>
    <style>
        body {
            background-color: black;

            color: #4df24d;

            font-family: 'Courier New', Courier, monospace;
        }

        .container {
            display: flex;
        }

        .container section {
            width: 50%;
        }

        #widget-holder canvas {
            margin-inline: auto;
        }
    </style>
    <script src="p5.js"></script>

</head>

<body>
    <div class="container">
        <section>
            <h1>Hacking Station</h1>

            <p>Possible ports (substitude for PORT_NAME)</p>
            <ul>
                <li>MODEM</li>
                <li>BEATS</li>
                <li>BASS</li>
                <li>CASSETTE</li>
                <li>PADS</li>
            </ul>
        
            <p>Arrays (substitute for ARRAY_NAME)</p>
            <ul>
                <li>calm_voice_1, calm_voice_2, calm_voice_3 (voices of the pads, 1 is on 0 is off)</li>
            </ul>
        
            <p>list of commands</p>
            <ul>
                <li>birth PORT_NAME</li>
                <li>murder PORT_NAME</li>
                <li>list-set ARRAY_NAME</li>
            </ul>
        
            <p>TODO commands</p>
            <ul>
                <li>vset PORT_NAME (volume set)</li>
                <li>kneecap PORT_NAME</li>
                <li>
                    for drums
                    <ul>
                        <li></li>
                    </ul>
                </li>
            </ul>
        
            <br>

            <br>
        
            <form id="form">
                <input id="cmd" type="text" placeholder="your command here" size="80" />

                <button onclick="go('quiz')">Enter command</button>
            </form>
        </section>

        <section>
            <div id="widget-holder"></div>
            <textarea id="out" cols="80" rows="5">
            </textarea>
        
            <button onclick="multiout()">send multicmd</button>
        </section>
    </div>

    <script>
        document.getElementById("form").addEventListener("submit", (event) => { event.preventDefault(); go()})
        function question() {
            let a = Math.ceil(Math.random() * 10);
            let b = Math.ceil(Math.random() * 12);
            let c = Math.ceil(Math.random() * 5);

            let answer = prompt(`What is ${a} * ${b} * ${c}?`);

            return parseInt(answer) === a * b * c;
        }

        let ws = new WebSocket("ws://trisolaris.local:3000");

        function go() {
            let elem = document.getElementById('cmd');

            // if (!question()) {
            //     elem.disabled = true;

            //     setTimeout(() => elem.disabled = false, 5000);
            //     return;
            // }

            if (elem.value.startsWith("open")) {
                let sections = elem.value.split(' ');
                if (sections[1] === "PADS") {
                    state = "PADS";
                }

                return;
            } else if (elem.value.startsWith("close")) {
                state = "NONE";
                return;
            }

            ws.send(elem.value);
        }

        function multiout() {
            let cmds = document.getElementById('out').value.split('\n').filter(row => row.length !== 0);

            cmds.forEach(cmd => {
                console.log('sending', cmd);
                ws.send(cmd);
            })
        }
    </script>

    <script>
        let rows = [[], [], []];
        let positions = [];

        let state = "NONE";

        let count = 16;

        function setup() {
            let canvas = createCanvas(400, 400);
            canvas.parent('widget-holder');

            rows = rows.map(row => [...Array.from({ length: count }).fill(undefined)]);
        }

        function draw() {
            background('darkgreen');
            stroke('none');

            if (state === "NONE") {
                if (mouseIsPressed) {
                    fill(0);

                    if (frameCount % 20 === 0) {
                        ws.send("tweak " + mouseX/width)
                    }
                } else {
                    fill(255);
                }

                ellipse(mouseX, mouseY, 80, 80);
            } else if (state === "PADS") {
                document.getElementById('out').value = rows.map((row, i) => `list-set calm_voice_${i+1} ` + row.map(v => v ? 1 : 0).join(' ')).join('\n');

                push()
                noStroke();
                rows.forEach((_, i) => {
                    fill(i % 2 === 0 ? 'green' : 'grey');
                    rect(0, height/rows.length*i, width, width/rows.length*(i+1))
                })
                pop()

                for (let i = 0; i < 4; i++) {
                    fill(0, 30);
                    push()

                    noStroke();
                    if (i % 2 === 0) {
                        rect(width/4*i, 0, width/4, height)
                    }

                   pop()
                }

                if (mouseIsPressed && mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
                    let row = Math.floor(mouseY/(height/rows.length));

                    let val = (keyIsDown(SHIFT)) ? undefined : mouseY;

                    rows[row][Math.floor(mouseX/(width/count))] = val;
                }

                for (let i = 0; i < rows.length; i++) {
                    let positions = rows[i];
                    for (let x = 1; x < rows[i].length; x++) {
                        if (!positions[x]|| !positions[x-1]) {
                            continue;
                        }

                        line((x-1 + .5)*(width/count), positions[x-1], (x+.5)*(width/count), positions[x]);
                    }

                    positions.forEach((y, x) => {
                        push();
                        if (Math.floor(mouseX/(width/count)) === x) {
                            fill("blue");
                        }
                        circle((x+.5)*(width/count), y, 10);
                        pop();
                    })
                }
            } else if (state === "BEATS") {
                
            }
        }
    </script>
</body>

</html>